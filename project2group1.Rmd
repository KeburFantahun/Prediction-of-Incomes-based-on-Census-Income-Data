---
title: "Project 2"
author: "Kebur Fantahun, Ben Goodwin, Andre Mauldin"
date: "3/30/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## This markdown document contains the collective work of group one for MSDS6372, Spring 2021

## Global Notes:

# We have elected to use dataset 2,	https://archive.ics.uci.edu/ml/datasets/Adult, Predicting if someone makes over 50k
# All inference will be based on these data

##All EDA and analysis performed on test data

######################################################################################################################################################

```{r}
#Libraries
#Try to add libraries up here to avoid clutter and to better manage libraries
library(tidyverse)
library(MASS)
library(naniar)
library(caret)
library(plyr)
library(broom)
library(imbalance)
library(randomForest)
library(kernlab)
library(ROCR)
```

```{r}
#Time to bring in the data and rename columns

incomeDataMaster <- read.csv("adult.csv")
#Check import
#View(incomeDataUSE)

incomeDataTestMaster <- read.csv("adultTest.csv")
#Check import
#View(incomeDataTestMaster)

#Create some copies of the data
incomeDataUSE <- incomeDataMaster
#Check import
#View(incomeDataTestMaster)

#Rename Columns, use dplyr, using "incomeDataUSE" file
#Will rename based on "adult.names" file for consistency

#Col 1, X39, changed to Age
#Description: Age of subject, continuous
incomeDataUSE <-  incomeDataUSE %>% dplyr::rename(Age = X39)
incomeDataTestMaster <- incomeDataTestMaster %>%dplyr::rename(Age = X25)

#Col 2, State.gov, changed to workclass
#Description: Private, Self-emp-not-inc, Self-emp-inc, Federal-gov, Local-gov, State-gov, Without-pay, Never-worked. Factor
incomeDataUSE <-  incomeDataUSE %>% dplyr::rename(workclass = State.gov)
incomeDataTestMaster <- incomeDataTestMaster %>% dplyr::rename(workclass = Private)

#Col 3, X77516, changed to fnlwgt
#Description: final weight. In other words, this is the number of people the census believes. the entry represents
incomeDataUSE <-  incomeDataUSE %>% dplyr::rename(fnlwgt = X77516)
incomeDataTestMaster <- incomeDataTestMaster%>% dplyr::rename(fnlwgt = X226802)

#Col 4, Bachelors, changed to education
#Description: Bachelors, Some-college, 11th, HS-grad, Prof-school, Assoc-acdm, Assoc-voc, 9th, 7th-8th, 12th, Masters, 1st-4th, 10th, Doctorate, 5th-6th, Preschool.
incomeDataUSE <-  incomeDataUSE %>% dplyr::rename(Education = Bachelors)
incomeDataTestMaster <- incomeDataTestMaster %>% dplyr::rename(Education = X11th)

#Col 5, X13, changed to education-num
#Description: stands for the number of years of education in total, which is a continuous representation of the discrete variable education
incomeDataUSE <-  incomeDataUSE %>% dplyr::rename("education-num" = X13)
incomeDataTestMaster <- incomeDataTestMaster%>% dplyr::rename("education-num" = X7)

#Col 6, Never.married, changed to marital-status
#Description: Married-civ-spouse, Divorced, Never-married, Separated, Widowed, Married-spouse-absent, Married-AF-spouse.
incomeDataUSE <-  incomeDataUSE %>%dplyr::rename("marital-status" = Never.married)
incomeDataTestMaster <- incomeDataTestMaster%>% dplyr::rename("marital-status" = Never.married)

#Col 7,Adm.clerical, changed to occupation
#Description: Tech-support, Craft-repair, Other-service, Sales, Exec-managerial, Prof-specialty, Handlers-cleaners, Machine-op-inspct, Adm-clerical, Farming-fishing, Transport-moving, Priv-house-serv, Protective-serv, Armed-Forces.
incomeDataUSE <-  incomeDataUSE %>% dplyr::rename(occupation = Adm.clerical)
incomeDataTestMaster <- incomeDataTestMaster%>% dplyr::rename(occupation = Machine.op.inspct)

#Col 8, Not.in.family, changed to relationship
#Description:  Wife, Own-child, Husband, Not-in-family, Other-relative, Unmarried.
incomeDataUSE <-  incomeDataUSE %>% dplyr::rename(relationship = Not.in.family)
incomeDataTestMaster <- incomeDataTestMaster%>% dplyr::rename(relationship = Own.child)

#Col 9, White, changed to race
#Description: White, Asian-Pac-Islander, Amer-Indian-Eskimo, Other, Black
incomeDataUSE <-  incomeDataUSE %>% dplyr::rename(race = White)
incomeDataTestMaster <- incomeDataTestMaster%>% dplyr::rename(race = Black)

#Col 10, Male, changed to sex
#Description: Female, Male
incomeDataUSE <-  incomeDataUSE %>% dplyr::rename(sex = Male)
incomeDataTestMaster <- incomeDataTestMaster%>% dplyr::rename(sex = Male)

#Col 11, X2174, changed to capital-gain
#Description: Describing income from financial investments
incomeDataUSE <-  incomeDataUSE %>% dplyr::rename("capital-gain" = X2174) 
incomeDataTestMaster <- incomeDataTestMaster%>% dplyr::rename("capital-gain" = X0)

#Col 12, X0, changed to capital-loss
#Description: Describing loss from financial investments
incomeDataUSE <-  incomeDataUSE %>%  dplyr::rename("capital-loss" = X0) 
incomeDataTestMaster <- incomeDataTestMaster%>% dplyr::rename("capital-loss" = X0.1) 

#Col 13, X40, changed to hours-per-week
#Description: Number of hours worked per week
incomeDataUSE <-  incomeDataUSE %>%  dplyr::rename("hours-per-week" = X40) 
incomeDataTestMaster <- incomeDataTestMaster%>%  dplyr::rename("hours-per-week" = X40) 

#Col 14,United.States, changed to native-country
#Description: Native country of subject
incomeDataUSE <-  incomeDataUSE %>%  dplyr::rename("native-country" = "United.States") 
incomeDataTestMaster <- incomeDataTestMaster%>% dplyr::rename("native-country" = "United.States")

#Col 15, X..50K, changed to income
#Description: Income
incomeDataUSE <-  incomeDataUSE %>% dplyr::rename(income = X..50K) 
incomeDataTestMaster <- incomeDataTestMaster%>% dplyr::rename(income = X..50K.) 

```

```{r}
#Lets fix up the data 

#Change outcome to factor
incomeDataUSE$income <- as.factor(incomeDataUSE$income)
incomeDataTestMaster$income <- as.factor(incomeDataTestMaster$income)
#Lets dump some variables
incomeDataUSE <- dplyr::select(incomeDataUSE, -Education, -fnlwgt, -relationship)
incomeDataTestMaster <- dplyr::select(incomeDataTestMaster, -Education, -fnlwgt, -relationship)
#Reason for dropping education
#Education level is present in the data and is numeric, thus equivalent and easier to handle

#Reason for dropping fnlwgt
#Just don"t know how to use this weighting variable

#Reason for dropping relationship
#This is encapsulated in gender and family role, essentially a duplicate variable

#A few more variables to drop
incomeDataUSE <- dplyr::select(incomeDataUSE,-"capital-gain", -"capital-loss", -"native-country")
incomeDataTestMaster <- dplyr::select(incomeDataTestMaster,-"capital-gain", -"capital-loss", -"native-country")
#Reason for dropping capital gain
#Around 90% of observations don't feature this

#Reason for dropping capital loss
#Around 90% of observations don't feature this

#Reason for dropping native country 
#Most observations are from the US and skew the data

#We can also make a few of the variables nicer to work with
#Fist up, fix workclass
#Objective here is to combine some of the working classes
#Govt jobs can be combined

#Change "?" to unknown, but first make it factor
incomeDataUSE$workclass <- as.factor(incomeDataUSE$workclass)
incomeDataTestMaster$workclass <- as.factor(incomeDataTestMaster$workclass)
levels(incomeDataUSE$workclass)[1] <- 'Unknown'
levels(incomeDataTestMaster$workclass)[1] <- 'Unknown'
# combine into Government job
incomeDataUSE$workclass <- gsub('Federal-gov', 'Government', incomeDataUSE$workclass)
incomeDataUSE$workclass <- gsub('Local-gov', 'Government', incomeDataUSE$workclass)
incomeDataUSE$workclass <- gsub('State-gov', 'Government', incomeDataUSE$workclass) 
incomeDataTestMaster$workclass <- gsub('Federal-gov', 'Government', incomeDataTestMaster$workclass)
incomeDataTestMaster$workclass <- gsub('Local-gov', 'Government', incomeDataTestMaster$workclass)
incomeDataTestMaster$workclass <- gsub('State-gov', 'Government', incomeDataTestMaster$workclass) 


# combine into Self-Employed job
incomeDataUSE$workclass <- gsub('Self-emp-inc', 'Self-Employed', incomeDataUSE$workclass)
incomeDataUSE$workclass <- gsub('Self-emp-not-inc', 'Self-Employed', incomeDataUSE$workclass)
incomeDataTestMaster$workclass <- gsub('Self-emp-inc', 'Self-Employed', incomeDataTestMaster$workclass)
incomeDataTestMaster$workclass <- gsub('Self-emp-not-inc', 'Self-Employed', incomeDataTestMaster$workclass)

# combine into Other/Unknown
incomeDataUSE$workclass <- gsub('Other', 'Other/Unknown', incomeDataUSE$workclass)
incomeDataUSE$workclass <- gsub('Unknown', 'Other/Unknown', incomeDataUSE$workclass)
incomeDataTestMaster$workclass <- gsub('Other', 'Other/Unknown', incomeDataTestMaster$workclass)
incomeDataTestMaster$workclass <- gsub('Unknown', 'Other/Unknown', incomeDataTestMaster$workclass)


incomeDataUSE <- incomeDataUSE[-c(1901,5361,9257,10845,14772,15533,15695,16812,20073,20337,21944,22215,23232,24596,25500,27747,28829,29158,32262,32304,32314),]
incomeDataTestMaster <- incomeDataTestMaster[-c(2957,3177,6466,8785,8903,10647,11607,13836,13898,14034),]
incomeDataUSE$workclass <- as.factor(incomeDataUSE$workclass)
incomeDataTestMaster$workclass <- as.factor(incomeDataTestMaster$workclass)
summary(incomeDataUSE$workclass)
summary(incomeDataTestMaster$workclass)

```

```{r}
#Time for some EDA

#First up, check the completeness of the data
vis_miss(incomeDataUSE)
#How convenient, data is complete, and no data is missing

# Make a histogram of age and income
ggplot(incomeDataUSE) + aes(x=as.numeric(Age), group=income, fill=income) + 
  geom_histogram(binwidth=1, color='black')
#Looks like <=50k dominates
#Otherwise pretty typical look for income distribution

# Make a histogram of age and sex
ggplot(incomeDataUSE) + aes(x=as.numeric(Age), group=sex, fill=sex) + 
  geom_histogram(binwidth=1, color='black')

# Make a histogram of age and workclass

ggplot(incomeDataUSE) + aes(x=as.numeric(Age), group=workclass, fill=workclass) + 
  geom_histogram(binwidth=1, color='black')

#Make bar plot of Education vs income by group
####################################################################################
eduVsIncomeDf <- data.frame(table(incomeDataUSE$`education-num`, incomeDataUSE$income))
names(eduVsIncomeDf) <- c('Education', 'income', 'count')
#test
eduVsIncomeDf

# calculate the percentages
eduVsIncomeDf <- ddply(eduVsIncomeDf, .(Education), transform, percent = count/sum(count) * 100)
eduVsIncomeDf
# format the labels and calculate their positions
eduVsIncomeDf <- ddply(eduVsIncomeDf, .(Education), transform, pos = (cumsum(count) - 0.5 * count))
eduVsIncomeDf$label <- paste0(sprintf("%.0f", eduVsIncomeDf$percent), "%")

# bar plot of counts by marital status with in group proportions 
ggplot(eduVsIncomeDf, aes(x = Education, y = count, fill = income)) +
  geom_bar(stat = "identity") +
  geom_text(aes(y = pos, label = label), size = 2) + 
  ggtitle('Education Level with Income')
####################################################################################

#Plot of work-class distribution
p<-ggplot(data=incomeDataUSE, aes(x=workclass, y="count", fill=workclass)) +
  geom_bar(stat="identity")+ggtitle("Work-Class Distribution")+ylab("Count")+xlab("Categories")
p

#Plot of work-class distribution
p<-ggplot(data=incomeDataUSE, aes(x=occupation, y="count", fill=income)) +
  geom_bar(stat="identity")+ggtitle("Occupation Distribution")+ylab("Count")+xlab("Categories")

p + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

#Plot race vs income
p<-ggplot(data=incomeDataUSE, aes(x=race, y="count", fill=income)) +
  geom_bar(stat="identity")+ggtitle("Race Vs. Income")+ylab("Count")+xlab("Categories")
p + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))


#Plot Sex vs income
p<-ggplot(data=incomeDataUSE, aes(x=sex, y="count", fill=income)) +
  geom_bar(stat="identity")+ggtitle("Occupation Distribution")+ylab("Count")+xlab("Categories")
p
```


```{r}

#Do the logistic regression
lreg <- glm(income~.,data=incomeDataUSE,family = binomial('logit'))

#Generate Summary Stats
summary(lreg)

#Generate Paramter CI's
confint(lreg)

#Copy Model into var
completeModel <- lreg
completeModel <- glm(income ~ 1, data = incomeDataUSE, family = binomial('logit'))

# backward selection
step(completeModel, trace = F, scope = list(lower=formula(completeModel), upper=formula(completeModel)),direction = 'backward')

# forward selection
step(completeModel, trace = F, scope = list(lower=formula(completeModel), upper=formula(completeModel)),direction = 'forward')

#Plot Residuals
index <- 1:dim(incomeDataUSE)[1]
dev_resid <- residuals(lreg)
income <- incomeDataUSE$income
dff <- data.frame(index, dev_resid, income)

p <- ggplot(dff, aes(x = index, y = dev_resid, color = income)) +
  geom_point()+theme_minimal()+ggtitle("Residual Plot for Income Groups")+xlab("Subject #")+ylab("Residuals")
p

#Plot Cooks distance
plot(lreg,which=4,id.n=3)

#Plot Leverage
plot(lreg,which = 5)

##################

#Do the predictions form test dataset
prob <- predict(lreg, incomeDataTestMaster, type = 'response')
pred <- rep('<=50K', length(prob))
pred[prob>=.5] <- '>50K'

# Generate Confusion Matrix
tb <- table(pred, incomeDataTestMaster$income)
tb

#Here we are doing some basic measures from the confusion matrix
tbSum <- tb[1,1]+tb[1,2]+tb[2,1]+tb[2,2]
tp <- tb[1,1]+tb[2,2]
TPR <- tp/tbSum

#Accuracy
TPR

#Error Rate
ER <- (tb[2,1]+tb[1,2])/tbSum
ER

#Sensitivity
SensitivityMetric <- (tb[1,1])/(tb[1,1]+tb[2,1])
SensitivityMetric

#Specificity
SpecificityMetric <- (tb[2,2])/(tb[1,2]+tb[2,2])
SpecificityMetric

#Precision
PrecisionMetric <- (tb[1,2])/(tb[1,1]+tb[2,1])
PrecisionMetric

#False Positive Rate
FPR <- 1-SpecificityMetric
FPR

#Old
##########################################################################################
#Lets first split up the data, 80,20 should do it
#trainIndex <- createDataPartition(incomeDataUSE$income, p = .8, list = FALSE, times = 1)
#dtrain<-incomeDataUSE[trainIndex,]
#dtest<-incomeDataUSE[-trainIndex,]

# 10-fold CV
#fitControl <- trainControl(method = "cv",number = 10,savePredictions = TRUE)
#lreg<-train(income~.,data=incomeDataUSE,method="glm",family=binomial(),trControl=fitControl)
#summary(lreg)
#varImp(lreg)


#lreg_pred<-predict(lreg,incomeDataTestMaster)
#confusionMatrix(lreg_pred,incomeDataTestMaster$income)



```



##Objective 2


#Create a more complicated logistic regression model
```{r}
#Make the log data
incomeDatTrainlog <- incomeDataUSE
incomeDatTrainlog$Age <- log(incomeDataUSE$Age)
incomeTestlog <- incomeDataTestMaster
incomeTestlog$Age <- log(incomeTestlog$Age)
#Do the logistic regression
lreg <- glm(income~.,data=incomeDatTrainlog,family = binomial('logit'))

#Generate Summary Stats
summary(lreg)

#Generate Paramter CI's
confint(lreg)

#Copy Model into var
completeModel <- lreg
completeModel <- glm(income ~ 1, data = incomeDatTrainlog, family = binomial('logit'))

# backward selection
step(completeModel, trace = F, scope = list(lower=formula(completeModel), upper=formula(completeModel)),direction = 'backward')

# forward selection
step(completeModel, trace = F, scope = list(lower=formula(completeModel), upper=formula(completeModel)),direction = 'forward')

#Plot Residuals
index <- 1:dim(incomeDatTrainlog)[1]
dev_resid <- residuals(lreg)
income <- incomeDatTrainlog$income
dff <- data.frame(index, dev_resid, income)

p <- ggplot(dff, aes(x = index, y = dev_resid, color = income)) +
  geom_point()+theme_minimal()+ggtitle("Residual Plot for Income Groups")+xlab("Subject #")+ylab("Residuals")
p

#Plot Cooks distance
plot(lreg,which=4,id.n=3)

#Plot Leverage
plot(lreg,which = 5)

#Do the predictions form test dataset
probLog <- predict(lreg, incomeTestlog, type = 'response')
pred <- rep('<=50K', length(probLog))
pred[prob>=.5] <- '>50K'

# Generate Confusion Matrix
tb <- table(pred, incomeTestlog$income)
tb

#Here we are doing some basic measures from the confusion matrix
tbSum <- tb[1,1]+tb[1,2]+tb[2,1]+tb[2,2]
tp <- tb[1,1]+tb[2,2]
TPR <- tp/tbSum

#Accuracy
TPR

#Error Rate
ER <- (tb[2,1]+tb[1,2])/tbSum
ER

#Sensitivity
SensitivityMetric <- (tb[1,1])/(tb[1,1]+tb[2,1])
SensitivityMetric

#Specificity
SpecificityMetric <- (tb[2,2])/(tb[1,2]+tb[2,2])
SpecificityMetric

#Precision
PrecisionMetric <- (tb[1,2])/(tb[1,1]+tb[2,1])
PrecisionMetric

#False Positive Rate
FPR <- 1-SpecificityMetric
FPR




```

#Create another competing model using continuous predictors with LDA or QDA
```{r}
#Build up LDA
lda_income <- lda(income ~Age+`education-num` +`hours-per-week`,data=incomeDataUSE)

#Plot model
plot(lda_income)

#Prediction
predictLDA <- predict(lda_income,newdata=incomeDataTestMaster)

#CM
ldaCM <- table(incomeDataTestMaster$income,predictLDA$class)
ldaCM

#Classification Rate
ldaFinal <- ldaCM %>% prop.table() %>% round(3)
ldaFinal
```



#This block contains an attempt at a support vector machine, nonparametric model to compare to
```{r}
svmIncomeModel <- ksvm(income ~ ., data = incomeDataUSE)
svmIncomeModelPredictions <- predict(svmIncomeModel, newdata = incomeDataTestMaster, type = 'decision')
svmIncomeModelFinal <- predict(svmIncomeModel, newdata = incomeDataTestMaster, type = 'response')


#Now create confusion matrix for SVM
svmCM <- table(svmIncomeModelFinal, incomeDataTestMaster$income)
svmCM

#Here we are doing some basic measures from the confusion matrix
tbSum <- svmCM[1,1]+svmCM[1,2]+svmCM[2,1]+svmCM[2,2]
tp <- svmCM[1,1]+svmCM[2,2]
TPR <- tp/tbSum


#Accuracy
TPR

#Error Rate
ER <- (svmCM[2,1]+svmCM[1,2])/tbSum
ER

#Sensitivity
SensitivityMetric <- (svmCM[1,1])/(svmCM[1,1]+svmCM[2,1])
SensitivityMetric

#Specificity
SpecificityMetric <- (svmCM[2,2])/(svmCM[1,2]+svmCM[2,2])
SpecificityMetric

#Precision
PrecisionMetric <- (svmCM[1,2])/(svmCM[1,1]+svmCM[2,1])
PrecisionMetric

#False Positive Rate
FPR <- 1-SpecificityMetric
FPR



```


#Create an ROC curve for each model, plot it, and then add to AUC table
```{r}
# create a prediction object
pr <- prediction(prob, incomeDataTestMaster$income)
prf <- performance(pr, measure = "tpr", x.measure = "fpr")

pr1 <- prediction(probLog, incomeTestlog$income)
prf1 <- performance(pr1, measure = "tpr", x.measure = "fpr")

# create a data frame for TP and FP rates
dd <- data.frame(FP = prf@x.values[[1]], TP = prf@y.values[[1]])
dd2 <- data.frame(FP = prf1@x.values[[1]], TP = prf1@y.values[[1]])

# SVM
pr4 <- prediction(svmIncomeModelPredictions, incomeDataTestMaster$income)
prf4 <- performance(pr4, measure = "tpr", x.measure = "fpr")
dd4 <- data.frame(FP = prf4@x.values[[1]], TP = prf4@y.values[[1]])

# plot ROC curve for logistic regression
g <- ggplot() + 
  geom_line(data = dd, aes(x = FP, y = TP, color = 'Logistic Regression')) + 
   
  geom_line(data = dd2, aes(x = FP, y = TP, color = 'Logged Logistic Regression')) + 

  geom_line(data = dd4, aes(x = FP, y = TP, color = 'Support Vector Machine')) +
  geom_segment(aes(x = 0, xend = 1, y = 0, yend = 1)) +
  ggtitle('ROC Curve') + 
  labs(x = 'False Positive Rate', y = 'True Positive Rate') 


g +  scale_colour_manual(name = 'Classifier', values = c('Logistic Regression'='Plum', 
                                               'Logged Logistic Regression'='Salmon','Support Vector Machine'='#0072B2'))

# AUC
auc <- rbind(performance(pr, measure = 'auc')@y.values[[1]],
             performance(pr4, measure = 'auc')@y.values[[1]])
rownames(auc) <- (c('Logistic Regression', 'Support Vector Machine'))
colnames(auc) <- 'Area Under ROC Curve'
round(auc, 4)
```




